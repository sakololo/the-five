# 🔒 External Auditor Report - Final Gatekeeper Review

**監査者**: 外部トラブルシューティング専門家
**日付**: 2026-02-03
**対象**: 検索ランキング改善（Spinoff Penalty / Deduplication）

---

## 📋 エグゼクティブサマリー

| 判定 | 理由 |
|------|------|
| ⚠️ **条件付き承認** | コアロジックは正しいが、技術的負債と設計上の懸念が残存 |

---

## 🔴 Critical Issues（重大な問題）

### 1. Normalizer のバグ放置 - "ONE PIECEース" 問題

**現状**: `normalizer.ts` L201
```typescript
finalNormalized = normalizedChars.replace(key, aliasResult.resolved);
```

**問題点**:
- `key = "ワンピ"` で `normalizedChars = "ワンピース"` の場合
- 結果: `"ONE PIECEース"` という**不正な文字列**が生成される
- これは本番環境で **ユーザーに見える可能性がある**（検索結果の表示やログ）

**Blue/Red Team の判断**:
> "Scorerの緩和で機能的には問題なし。許容範囲と判断。"

**外部監査の判断**:
> **甘い。** これは「動くからOK」ではなく、**コードの品質問題**である。
> ユーザーがこの文字列を目にした場合、アプリケーションへの信頼が損なわれる。
> 「技術的負債」として片付けるべきではない。

**推奨**: 
- `MANGA_ALIASES` に `"ワンピース": "ONE PIECE"` を追加するか
- 部分一致置換を禁止し、キーが完全一致した場合のみ置換する

---

### 2. SPINOFF_KEYWORDS の不完全性

**現状**: `scorer.ts` L49-54
```typescript
const SPINOFF_KEYWORDS = [
    'ガイドブック', 'ファンブック', 'キャラクターブック',
    '外伝', '小説版', 'ノベライズ', 'アンソロジー',
    'イラスト集', 'エピソードオブ',
    'CHOPPER', 'チョッパー',
];
```

**見落とされているキーワード** (実テストで確認):
| 見逃しタイトル | 必要なキーワード |
|----------------|------------------|
| VIVRE CARD〜ONE PIECE図鑑〜 | `図鑑` |
| ジョジョの奇妙な冒険TVアニメ原画集AAA | `原画集` |
| キャラクターズブック | `キャラクターズブック` (「ズ」の有無) |
| 〇〇考察GOLD | `考察` (非公式解説本) |

**リスク**: ユーザーが「ワンピース」を検索したとき、これらの関連商品が本編と同列に表示される。

**推奨**: キーワードリストを拡充するか、またはAPIのメタデータ（カテゴリ情報）を利用するアプローチを検討。

---

## 🟡 Medium Issues（中程度の問題）

### 3. `queryHasSpinoffKw` ロジックの潜在的脆弱性

**現状**: `scorer.ts` L169-172
```typescript
const queryHasSpinoffKw = SPINOFF_KEYWORDS.some(keyword => {
    const normalizedKw = keyword.replace(/[\s・]/g, '').toLowerCase();
    return normalizedQuery.includes(normalizedKw);
});
```

**攻撃シナリオ**:
ユーザーが `"外伝"` という文字を含む**無関係な作品**を検索した場合：
- 例: `"聖魔女外伝"` (架空のメイン作品タイトル)
- `normalizedQuery` が `"外伝"` を含む
- → すべてのスピンオフペナルティが解除される
- 結果: 真のスピンオフ作品（他作品のファンブックなど）がノイズとして浮上

**リスクレベル**: 低（そのようなタイトルは稀）だが、ゼロではない。

**推奨**: 
- このリスクを許容するなら、コメントで明記
- 許容しないなら、キーワードの出現位置（接尾辞かどうか）を考慮するロジックに強化

---

### 4. Deduplication の「勝者選定」ロジック

**現状**: `deduplicator.ts` L43
```typescript
if (book.score > existing.score) {
    seenSeries.set(key, book);
}
```

**問題点**:
- スコアが同点の場合、**最初に登場した方**が勝つ
- 入力リストのソート順に依存している（暗黙の前提）

**リスク**: もしソート順が変わった場合（例: API側の変更）、勝者が予期せず変わる可能性。

**推奨**: 同点時のタイブレーカー（例: volumeNumber が小さい方を優先）を明示的に実装。

---

## 🟢 Positive Findings（良い点）

1. **`'s` の削除判断は正しい**: 英語タイトルの多くが含む文字を除外したのは適切。
2. **Cross-Language対応のアプローチ**: クエリに「チョッパー」があればタイトルの「CHOPPER」も許容するロジックは、現実的な解決策。
3. **テストカバレッジ**: 5つの実テストで主要シナリオがカバーされている。

---

## 📊 最終判定

| 領域 | 状態 | アクション |
|------|------|------------|
| スピンオフペナルティ | ✅ 機能要件を満たす | 承認 |
| Deduplication | ✅ 機能要件を満たす | 承認 |
| Normalizer (エイリアス置換) | ❌ バグ残存 | **要修正** |
| キーワードリスト | ⚠️ 不完全 | 改善推奨 |

---

## 🚀 アクションアイテム（優先順）

1. **[必須]** `MANGA_ALIASES` に `"ワンピース": "ONE PIECE"` を追加、または `normalizer.ts` の部分置換ロジックを修正
2. **[推奨]** `SPINOFF_KEYWORDS` に `図鑑`, `原画集`, `キャラクターズブック`, `考察` を追加
3. **[任意]** Deduplication のタイブレーカー実装

---

**External Auditor Sign-off**:
> 上記の**必須項目**が解決されるまで、本番デプロイは**保留**とすることを推奨。
> ただし、ステージング環境でのテストデプロイは許可。
