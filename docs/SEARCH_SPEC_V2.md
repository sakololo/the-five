# 検索仕様書 V2（DRAFT - 質問攻めフェーズ）

> **目的**: この文書は検索機能のすべての挙動を定義し、実装の「法」となるものです。曖昧な部分について、以下の質問に回答いただくことで仕様を確定します。

---

## 📋 質問攻め（Questionnaire）

### Q1: 副題・サブタイトルの扱い
**状況**: 「茶の涙_〜Larmes_de_the〜」のようなタイトルで、ユーザーが「茶の涙」のみを入力した場合。

**質問**:
1. これは「完全一致」とみなすべきですか？（50点のボーナスを付与）
2. それとも「部分一致」として扱い、ボーナスなしにすべきですか？
3. アンダースコア（`_`）や波線（`〜`）をすべて除去した上で比較すべきですか、それとも厳密に文字列が含まれているかで判定すべきですか？

**現状の挙動**: 
- `normalizeSeparators()` により、`_` や `〜` は空白に変換されます。
- 「茶の涙」と入力した場合、正規化後の検索クエリは「チャノナミダ」、タイトルは「チャノナミダ Larmes de the」のようになり、前方部分一致でExact Matchとみなされます。

---

### Q2: 短いタイトルのボーナスの妥当性
**状況**: 「アーシア」で検索し、「アーシアン」という作品が見つかる場合。

**質問**:
1. 現在、タイトルが30文字以下の場合「短いタイトルボーナス（+10点）」が付与されます。これは意図的に「シンプルなタイトルを優先」するためですが、適切ですか？
2. もしボーナスを廃止すると、「完全一致（50点）+ 第1巻（20点）= 70点」となり、ノイズフィルタ（40点）は適用されますが、順位付けに差が出なくなります。これで良いですか？

**現状の挙動**: 
- 「短いタイトルボーナス」により、30文字以下のタイトルは+10点されます（80点に到達）。

---

### Q3: スピンオフ・外伝の扱い
**状況**: 「ONE PIECE ファンブック」や「鬼滅の刃 外伝」のような派生作品。

**質問**:
1. ユーザーが「ONE PIECE」のみ入力した場合、「ファンブック」は結果に**含めるべきですか、除外すべきですか**？
2. もし除外する場合、現状の「スピンオフペナルティ（-100点）」で十分ですか？
3. ユーザーが明示的に「ONE PIECE ファンブック」と入力した場合は、ペナルティを解除して結果に含めるべきですか？（現在はそのように実装されています）

**現状の挙動**: 
- スピンオフキーワード（ファンブック、外伝等）が含まれる場合、-100点のペナルティ。
- ただし、ユーザーのクエリにそのキーワードが含まれている場合、ペナルティは免除されます。

---

### Q4: 感嘆符・記号の正規化
**状況**: 「ストップ!!_ひばりくん!」のようなタイトル。

**質問**:
1. `!` や `?` を区切り文字として扱い、空白に変換する現在の挙動は適切ですか？
2. それとも、これらの記号は「タイトルの一部」として保持すべきですか？
3. もし保持する場合、「ストップ!! ひばりくん」と「ストップ ひばりくん」は別タイトルとして扱われますが、これは望ましいですか？

**現状の挙動**: 
- `!`、`?` は区切り文字として空白に変換されます（`normalizeSeparators()`）。

---

### Q5: ノイズ除去の閾値（40点）
**状況**: トップ結果のスコアが40点以上の場合、40点未満の結果はすべて除外されます。

**質問**:
1. この閾値（40点）は適切ですか？
2. もっと厳しく（例：50点）すべきですか、それとも緩く（例：30点）すべきですか？
3. 「第1巻ボーナス（20点）+ 短いタイトルボーナス（10点）= 30点」の組み合わせで40点未満になるケースがあり得ます。これは許容すべきですか？

**現状の挙動**: 
- トップスコアが40以上の場合、40点未満の結果は除外されます。
- これにより「ONE PIECE（10点）」のような人気作品のノイズが排除されます。

---

### Q6: 巻数指定の優先度
**状況**: ユーザーが「ハヤテのごとく 1」と入力した場合。

**質問**:
1. 第1巻に**100点の巨大なボーナス**を与える現在の挙動は適切ですか？
2. これにより、タイトル一致が曖昧でも巻数が一致すれば上位に来ますが、これは望ましいですか？
3. 巻数指定がない場合の「第1巻ボーナス（20点）」との差（80点）は大きすぎませんか？

**現状の挙動**: 
- 巻数指定がある場合：一致すれば+100点。
- 巻数指定がない場合：第1巻なら+20点。

---

### Q7: カタカナ・ひらがなの正規化
**状況**: 「はいぱー少女」と入力し、「ハイパー少女」がヒットする。

**質問**:
1. ひらがな→カタカナの自動変換は維持すべきですか？
2. ユーザーが意図的にひらがなで入力した場合、それを尊重してカタカナタイトルを除外すべきですか？

**現状の挙動**: 
- すべてのひらがなは自動的にカタカナに変換されます（`normalizeCharacters()`）。

---

## 次のステップ
上記の質問に回答いただき次第、この仕様書を「確定版」として完成させます。その後、自動テストスイートを構築し、100%の適合を保証します。
