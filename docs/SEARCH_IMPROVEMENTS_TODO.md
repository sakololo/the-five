# 検索機能改善 TODO

> **作成日**: 2026-02-08  
> **ステータス**: 現状維持（変更なし）

---

## ✅ 完了済み

### プレースホルダー文言の変更
- [x] `page.tsx` のプレースホルダーを変更
  - 変更前: 「タイトルや作者名で検索」
  - 変更後: 「タイトルで検索」
  - 理由: UI約束と実装を一致させる

---

## 📋 今後のタスク

### Phase 1: SNS告知後に実行

#### 検索失敗ログの追加
- [ ] Supabaseテーブル作成
  ```sql
  CREATE TABLE failed_searches (
    id BIGSERIAL PRIMARY KEY,
    query TEXT NOT NULL,
    original_query TEXT,
    was_alias_resolved BOOLEAN,
    timestamp TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
  );
  ```

- [ ] `route.ts` にログ記録を追加
  ```typescript
  // 検索結果が0件の場合にログ
  if (filteredBooks.length === 0) {
    await supabase.from('failed_searches').insert({
      query: normalizedQuery,
      original_query: query,
      was_alias_resolved: wasAliasResolved,
      timestamp: new Date().toISOString()
    })
  }
  ```

- [ ] 実装時期: SNS告知後、ユーザーが増えてから

---

### Phase 2: 継続的改善（月次）

#### エイリアス辞書の拡充
- [ ] 月次で `failed_searches` テーブルを確認
- [ ] 頻出する検索失敗クエリをリスト化
- [ ] マイナー作品のエイリアスを `aliases.ts` に追加
- [ ] コアユーザーの満足度向上

#### 1文字タイトル作品のエイリアス追加
- [ ] 新しい人気1文字タイトル作品を発見
- [ ] 楽天APIレスポンスで正確なタイトル表記を確認
- [ ] エイリアス辞書に追加（複数検索パターン）

**確認済み作品**:
- ✅ 「チ。-地球の運動についてー」(6パターン)
- ✅ 「響～小説家になる方法～」(4パターン)

**候補作品例**:
- 「H2」「K」などのアルファベット1文字作品

#### 分析SQL（参考）
```sql
-- 検索失敗が多い作品トップ20
SELECT 
  query,
  COUNT(*) as fail_count
FROM failed_searches
WHERE created_at >= NOW() - INTERVAL '30 days'
GROUP BY query
ORDER BY fail_count DESC
LIMIT 20;
```

---

## 🚫 やらないこと（結論済み）

### keywordフォールバックの削除
- ❌ **実施しない**
- 理由: コアユーザー（マイナー作品愛好家）の検索成功率が最優先
- 結論: 現在の実装（title + keywordフォールバック）が最適

### 著者検索機能の追加
- ❌ **実施しない**
- 理由: サイトの目的（好きな5冊を選ぶ）と不一致

### 文字数による検索モード自動切り替え
- ❌ **実施しない**
- 理由: 既存スコアリングと衝突、エッジケース多数

### Fuse.jsによるスマート並び替え
- ❌ **実施しない**
- 理由: 既存実装と重複、62KBのライブラリ追加は過剰

---

## 📝 メモ

### 現在の検索実装（最適）
1. エイリアス辞書で正規化（70,000行、約1,700作品）
2. `title` パラメータで検索（精密）
3. `keyword` フォールバック（マイナー作品カバー）
4. 8軸スコアリング + 多段階フィルタリング

### サイトのコアユーザー像
- マイナー作品愛好家
- サイトの「火種」となる層
- エイリアス辞書にない作品を選ぶ
- 彼らの満足度が最優先

---

## 新規: User Behavior Audit（最優先）

### 背景
Token Match機能の失敗から学んだ教訓：
- 「技術的に可能」≠「実装すべき」
- ユーザー行動データなしの設計は危険
- 仮説検証の欠如が架空のケースへの対応を生む

### プロセスの制度化

#### 1. 検索ログ実装
- [ ] Supabaseに`search_logs`テーブル作成
- [ ] すべての検索を記録（成功/失敗）
- [ ] クエリ、結果数、トップスコアを記録

#### 2. 月次分析
- [ ] 検索失敗パターンの特定
- [ ] 実際の入力パターンの収集
- [ ] ユーザー行動の文書化

#### 3. 新機能提案時の必須チェック
- [ ] ユーザー行動データはあるか？
- [ ] 仮説検証は実施したか？
- [ ] 代替案（既存機能）は検討したか？
- [ ] シンプルさを維持できるか？

#### 4. 敵対的レビューの拡張
- [ ] Red Teamの質問リストを更新
- [ ] 「User Behavior Red Team」の導入
- [ ] 機能の必要性を問う専門視点を追加

---

---

## 次回この会話を開いた時、このファイルを確認してください。

---

## 新規: Existing Code First プロトコル（最優先）

### 背景
ドロワー見落としミスから学んだ教訓：
- 既存実装を確認せずに新機能を提案
- 2-3時間の実装計画 → 実際は1時間以内で済んだ
- Token Match失敗と同じパターン：**確認不足**

### プロトコルの制度化

#### Phase 1: Visual Audit（視覚的確認）
新機能を提案する前に **必ず** 実施：
- [ ] ユーザーにスクリーンショットまたはデモを依頼
- [ ] 既存のUIを確認
- [ ] 似た機能がないか確認

**目的**: 視覚的に既存機能を把握

#### Phase 2: Code Audit（コード確認）
- [ ] 関連キーワードで grep 検索
  - 例: drawer, modal, popup, panel, state, open, close など
- [ ] 主要ファイルの構造を確認
  - page.tsx, layout.tsx など
- [ ] useState を grep して状態を確認
- [ ] 既存の API ルートを確認（/api/ ディレクトリ）

**目的**: コードレベルで既存機能を確認

#### Phase 3: Assumption Validation（仮定の検証）
- [ ] 自分の仮定をリストアップ
  - 「〜は実装されていないはず」
  - 「〜は新規に作る必要がある」
- [ ] 各仮定に証拠があるか確認
- [ ] 証拠がない仮定はユーザーに確認

**危険**: 証拠のない仮定

### チェックリスト: 新機能提案前（必須）

```markdown
## 既存機能確認チェックリスト

### Phase 1: Visual Audit
- [ ] ユーザーにスクリーンショットを依頼した
- [ ] 既存のUIを確認した
- [ ] 似た機能がないか確認した

### Phase 2: Code Audit
- [ ] 関連キーワードで grep 検索した
- [ ] 主要ファイルの構造を確認した
- [ ] useState/context を確認した
- [ ] 既存のAPIルートを確認した

### Phase 3: Assumption Validation
- [ ] 自分の仮定をリストアップした
- [ ] 各仮定に証拠があるか確認した
- [ ] 証拠がない仮定はユーザーに確認した

### Phase 4: 設計
- [ ] 既存機能を活用する方法を検討した
- [ ] 新規実装が本当に必要か再確認した
- [ ] 最小限の変更で済む方法を検討した
```

### 学んだこと

1. **スクリーンショットは最初に確認**
   - 誤り: 最後に確認
   - 正解: 最初に確認
   - 理由: 視覚的に既存機能を把握できる

2. **grep検索は複数のキーワードで**
   - 誤り: "drawer" のみ
   - 正解: drawer, modal, popup, panel など
   - 理由: 命名規則は予測不可能

3. **大きなファイルは構造から把握**
   - 誤り: 部分的に読む
   - 正解: useState を grep → 状態を把握
   - 理由: 状態から機能を推測できる

4. **仮定は危険**
   - 誤り: 「〜はないはず」と仮定
   - 正解: 「〜はあるか？」と確認
   - 理由: 仮定は往々にして間違っている

### Token Match と Existing Code の共通点

| 失敗 | 原因 | 教訓 |
|------|------|------|
| Token Match | User Behavior確認不足 | User Behavior Audit |
| Existing Code | Existing Code確認不足 | Existing Code First |

**共通パターン**: **確認不足**

### アクションアイテム

- [x] RCA ドキュメント作成
- [x] チェックリストを TODO に追加
- [ ] 次回の提案で実践
- [ ] 習慣化

---

**重要**: このプロトコルは User Behavior Audit と同じく、今後のすべての新機能提案で **必須** です。

