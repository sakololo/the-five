# ğŸ”´ RED TEAM: é˜²å¾¡ç­–æ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆ

**Persona**: Red Teamer (Attacker)
**Mission**: Blue Teamã®é˜²å¾¡ç­–ã«ç©´ãŒãªã„ã‹æ¤œè¨¼ã™ã‚‹

---

## é˜²å¾¡ç­– #1: Upstash Redis Rate Limiting

**Blue Teamææ¡ˆ**: Redisã§æ°¸ç¶šåŒ–

**Red Teamæ¤œè¨¼**:
```bash
# æ”»æ’ƒ: åˆ†æ•£IP + Redisã‚­ãƒ¼åˆ†æ•£
for i in {1..100}; do
  curl -H "X-Real-IP: 192.168.1.$i" "https://target/api/search?q=test"
done
```

**çµæœ**: âŒ **ã¾ã è„†å¼±**
- Rate LimitãŒIPå˜ä½ãªã‚‰ã€åˆ†æ•£IPã§çªç ´å¯èƒ½
- ä¿®æ­£: **ã‚°ãƒ­ãƒ¼ãƒãƒ«Rate Limitï¼ˆå…¨IPåˆè¨ˆï¼‰+ IPå˜ä½Rate Limit ã®äºŒé‡é˜²å¾¡**

```typescript
const globalLimit = new Ratelimit({ redis, limiter: Ratelimit.slidingWindow(1000, '60 s'), prefix: 'global' });
const ipLimit = new Ratelimit({ redis, limiter: Ratelimit.slidingWindow(10, '60 s'), prefix: 'ip' });

const globalResult = await globalLimit.limit('global');
const ipResult = await ipLimit.limit(ip);

if (!globalResult.success || !ipResult.success) {
  return NextResponse.json({ error: 'RATE_LIMITED' }, { status: 429 });
}
```

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âš ï¸ è¦ä¿®æ­£

---

## é˜²å¾¡ç­– #2: Origin Validationå‰Šé™¤

**Blue Teamææ¡ˆ**: å®Œå…¨å‰Šé™¤

**Red Teamæ¤œè¨¼**: âœ… **æœ‰åŠ¹**
- æ”»æ’ƒå¯¾è±¡ãŒãªããªã£ãŸ
- Rate Limitingã§åˆ¶å¾¡ã™ã‚‹ã®ã¯æ­£ã—ã„åˆ¤æ–­

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æ‰¿èª

---

## é˜²å¾¡ç­– #3: x-real-ipä½¿ç”¨

**Blue Teamææ¡ˆ**: Vercelè¨­å®šã®ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã¿ä¿¡é ¼

**Red Teamæ¤œè¨¼**:
```bash
curl -H "X-Real-IP: 1.2.3.4" "https://target/api/search?q=test"
```

**çµæœ**: âœ… **æœ‰åŠ¹**ï¼ˆVercelã®å ´åˆï¼‰
- Vercelã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã® `x-real-ip` ã‚’ä¸Šæ›¸ãã™ã‚‹
- ãŸã ã—ã€Vercelä»¥å¤–ã®ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã§ã¯è„†å¼±ã«ãªã‚‹å¯èƒ½æ€§

**æ³¨æ„**: ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒãŒVercelå›ºå®šã§ã‚ã‚‹ã“ã¨ã‚’å‰ææ¡ä»¶ã¨ã—ã¦æ˜è¨˜ã™ã‚‹ã“ã¨

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æ‰¿èªï¼ˆæ¡ä»¶ä»˜ãï¼‰

---

## é˜²å¾¡ç­– #4: æœ€å°200msãƒ¬ã‚¹ãƒãƒ³ã‚¹

**Blue Teamææ¡ˆ**: å…¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’200msä»¥ä¸Šã«å›ºå®š

**Red Teamæ¤œè¨¼**:
```bash
# æ”»æ’ƒ: çµ±è¨ˆçš„è§£æã§å·®ã‚’æ¤œå‡º
for i in {1..1000}; do
  time curl "https://target/api/search?q=A"
done | stats
```

**çµæœ**: âš ï¸ **å¼±ã„**
- 200msã®å›ºå®šã¯å®Ÿè£…ã‚³ã‚¹ãƒˆã«è¦‹åˆã‚ãªã„
- ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒã®å®Ÿç”¨çš„è„…å¨ã¯ä½ã„ï¼ˆã‚¨ã‚¤ãƒªã‚¢ã‚¹è¾æ›¸ã¯å…¬é–‹æƒ…å ±ã«è¿‘ã„ï¼‰

**ä¿®æ­£ææ¡ˆ**: **å‰Šé™¤**ï¼ˆéå‰°é˜²å¾¡ï¼‰

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âŒ ä¸æ¡ç”¨ï¼ˆã‚³ã‚¹ãƒ‘æ‚ªã„ï¼‰

---

## é˜²å¾¡ç­– #5: éšœå®³æ™‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãªã„

**Blue Teamææ¡ˆ**: Circuit Breakeræ™‚ã¯503è¿”å´ã®ã¿

**Red Teamæ¤œè¨¼**: âœ… **æœ‰åŠ¹**
- æ±šæŸ“ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œãªã„
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã¯æ‚ªåŒ–ã™ã‚‹ãŒã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯ç¢ºä¿

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æ‰¿èª

---

## é˜²å¾¡ç­– #6: LRU Cache (max 100)

**Blue Teamææ¡ˆ**: æœ€å¤§100ä»¶ + 10ç§’TTL

**Red Teamæ¤œè¨¼**:
```bash
# æ”»æ’ƒ: 100ä»¶ä»¥ä¸Šã®åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
for i in {1..200}; do
  curl "https://target/api/search?q=query_$i" &
done
```

**çµæœ**: âœ… **æœ‰åŠ¹**
- 100ä»¶è¶…ã¯ãƒ‡ãƒ‰ãƒ¥ãƒ¼ãƒ—ã•ã‚Œãšã«å€‹åˆ¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãªã‚‹ãŒã€ãã‚Œã§ã‚‚æœ‰é™
- ãƒ¡ãƒ¢ãƒªæ¯æ¸‡ã¯é˜²æ­¢ã•ã‚Œã‚‹

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æ‰¿èª

---

## é˜²å¾¡ç­– #7: 100æ–‡å­—åˆ¶é™

**Blue Teamææ¡ˆ**: MAX_QUERY_LENGTH = 100

**Red Teamæ¤œè¨¼**: âœ… **æœ‰åŠ¹**
- 100æ–‡å­— Ã— 1200ã‚¨ã‚¤ãƒªã‚¢ã‚¹ Ã— 2æ–¹å‘ = 240Kæ¯”è¼ƒï¼ˆè¨±å®¹ç¯„å›²ï¼‰

**è¿½åŠ ææ¡ˆ**: å…¥åŠ›ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã‚‚è¿½åŠ 
```typescript
const sanitizedQuery = query.replace(/[^\p{L}\p{N}\s]/gu, '').slice(0, 100);
```

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æ‰¿èªï¼ˆã‚µãƒ‹ã‚¿ã‚¤ã‚ºè¿½åŠ æ¨å¥¨ï¼‰

---

## é˜²å¾¡ç­– #8: Levenshteinå½¹å‰²åˆ†æ‹…

**Blue Teamææ¡ˆ**: Levenshteinã¯ã‚¿ã‚¤ãƒè£œæ­£å°‚ç”¨

**Red Teamæ¤œè¨¼**: âœ… **æœ‰åŠ¹**
- è¨­è¨ˆæ¬ é™¥ã§ã¯ãªãã€æœŸå¾…å€¤ã®å•é¡Œã ã£ãŸ
- ç•¥ç§°å¯¾å¿œã¯åˆ¥é€”ã€Œã‚¨ã‚¤ãƒªã‚¢ã‚¹æ‹¡å……ã€ã§å¯¾å¿œ

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æ‰¿èª

---

## é˜²å¾¡ç­– #9: Dead Codeå‰Šé™¤

**Blue Teamææ¡ˆ**: supabase importå‰Šé™¤

**Red Teamæ¤œè¨¼**: âœ… **æœ‰åŠ¹**

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æ‰¿èª

---

## é˜²å¾¡ç­– #10: Origin Leak

**Blue Teamææ¡ˆ**: Originæ¤œè¨¼å‰Šé™¤ã§ç„¡åŠ¹åŒ–

**Red Teamæ¤œè¨¼**: âœ… **æœ‰åŠ¹**

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æ‰¿èª

---

## æœ€çµ‚åˆ¤å®š

| # | é˜²å¾¡ç­– | Red Teamåˆ¤å®š | ä¿®æ­£è¦å¦ |
|---|--------|-------------|---------|
| 1 | Upstash Redis | âš ï¸ è¦ä¿®æ­£ | ã‚°ãƒ­ãƒ¼ãƒãƒ«+IPäºŒé‡åˆ¶é™ |
| 2 | Originå‰Šé™¤ | âœ… æ‰¿èª | - |
| 3 | x-real-ip | âœ… æ‰¿èª | Vercelå‰æã‚’æ˜è¨˜ |
| 4 | 200mså›ºå®š | âŒ ä¸æ¡ç”¨ | å‰Šé™¤ |
| 5 | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãªã„ | âœ… æ‰¿èª | - |
| 6 | LRU Cache | âœ… æ‰¿èª | - |
| 7 | 100æ–‡å­—åˆ¶é™ | âœ… æ‰¿èª | ã‚µãƒ‹ã‚¿ã‚¤ã‚ºè¿½åŠ  |
| 8 | Levenshteinå½¹å‰² | âœ… æ‰¿èª | - |
| 9 | Dead Codeå‰Šé™¤ | âœ… æ‰¿èª | - |
| 10 | Origin Leak | âœ… æ‰¿èª | - |

**çµè«–**: 2ç‚¹ã®ä¿®æ­£ã§**V2.2æ‰¿èªå¯èƒ½**
