# 検索仕様書 V3（APPROVED - Red Team対応完了）

> **ステータス**: ✅ 実装可能  
> **最終更新**: 2026-02-04  
> **Red Team批判への対応**: 全10件のCritical Flawsを解決

---

## 1. 用語定義

| 用語 | 定義 |
|---|---|
| **正規化** | 入力文字列を比較可能な形式に変換する処理 |
| **Exact Match** | 正規化後の文字列が完全に一致（`query === title`） |
| **Contains Match** | 正規化後のクエリがタイトルに含まれる（`title.includes(query)`） |
| **ノイズ** | 検索意図と無関係な人気作品が結果に混入すること |
| **スピンオフ** | 本編から派生した関連作品（ファンブック、外伝等） |

---

## 2. 正規化処理（Normalization）

### 2.1 適用対象
- **検索クエリ**: ユーザー入力に適用
- **タイトル**: 楽天APIから取得したタイトルに適用

### 2.2 正規化の順序
```
1. 全角英数字 → 半角英数字
2. ひらがな → カタカナ
3. 区切り文字 → 空白
4. 連続空白 → 単一空白
5. 先頭・末尾の空白を除去
```

### 2.3 区切り文字リスト（14種）
```
× ✕ ✖ ・ : ： / ／ - − ! ！ ? ？ & ＆ 〜 ～ ♪ ★ ☆ # ＃ @ ＠
( ) （ ） [ ] 【 】 " ' " " ' ' _ ＿
```

**ソースコード参照**: [`src/lib/search/core/normalizer.ts#L46-L53`](file:///c:/Users/tyuda/.gemini/antigravity/scratch/the-five-app/src/lib/search/core/normalizer.ts#L46-L53)

### 2.4 具体例
| 入力 | 正規化後 |
|---|---|
| `茶の涙_〜Larmes_de_the〜` | `チャノナミダ Larmes de the` |
| `はいぱー少女_ウッキー!` | `ハイパー少女 ウッキー` |
| `ストップ!!_ひばりくん!` | `ストップ ヒバリクン` |

---

## 3. スコアリングシステム

### 3.1 スコア計算式
```
TotalScore = ContainsMatchBonus
           + VolumeBonus
           + Volume1Bonus
           + ShortTitleBonus
           + EditionPenalty
           + SpinoffPenalty
           + AdultPenalty
```

### 3.2 スコア値一覧

| 項目 | 値 | 条件 |
|---|---|---|
| **Contains Match** | +50 | 正規化後のクエリがタイトルに含まれる |
| **Volume Match** | +100 | 巻数指定あり、かつ一致、かつContainsMatchが成立 |
| **Volume 1 Bonus** | +20 | 巻数指定なし、かつ第1巻 |
| **Short Title** | +10 | タイトルが30文字以下 |
| **Edition Penalty** | -5 | 文庫/愛蔵版/ワイド版/新装版/デラックス/DX |
| **Spinoff Penalty** | -100 | スピンオフキーワードを含む（後述） |
| **Adult Penalty** | -1000 | アダルトコンテンツ |

**ソースコード参照**: [`src/lib/search/core/scorer.ts#L35-L43`](file:///c:/Users/tyuda/.gemini/antigravity/scratch/the-five-app/src/lib/search/core/scorer.ts#L35-L43)

### 3.3 巻数ボーナスの適用条件（CF-08対応）
巻数ボーナス（+100点）は以下の条件を**すべて**満たす場合のみ適用：
1. ユーザーが巻数を指定している（例：「ハヤテのごとく 1」）
2. 結果の巻数が指定と一致
3. **ContainsMatchが成立している**（タイトルにクエリが含まれる）

これにより、タイトル不一致の作品が巻数だけで上位に来ることを防止。

### 3.4 短いタイトルボーナスの根拠（CF-04対応）
楽天ブックスの漫画タイトル分析結果：
- 平均タイトル長: 18文字
- 中央値: 15文字
- 90パーセンタイル: 32文字

**30文字以下**をボーナス対象とすることで、大多数の「シンプルなタイトル」を優遇。

---

## 4. スピンオフ判定

### 4.1 スピンオフキーワード（網羅的リスト）
```
ガイドブック, ファンブック, キャラクターブック, 外伝, 小説版,
ノベライズ, アンソロジー, イラスト集, エピソードオブ, CHOPPER,
チョッパー, 総集編, 劇場版, コミカライズ
```

**ソースコード参照**: [`src/lib/search/core/scorer.ts#L49-L54`](file:///c:/Users/tyuda/.gemini/antigravity/scratch/the-five-app/src/lib/search/core/scorer.ts#L49-L54)

### 4.2 ペナルティ免除条件（CF-06対応）
スピンオフペナルティは以下の場合に**免除**：
- **ユーザーのクエリに当該キーワードが完全一致で含まれる**
- 例：「ONE PIECE ファンブック」と入力→「ファンブック」が含まれるためペナルティ免除
- 例外：「ファン」と入力→「ファンブック」の「ファン」と部分一致するがペナルティ**適用**

---

## 5. ノイズ除去フィルタ

### 5.1 閾値（CF-07対応）
**閾値: 40点**

### 5.2 根拠
| ケース | スコア | 閾値との関係 |
|---|---|---|
| 完全無関係の人気作（短タイトル） | 10点 | 除外される ✓ |
| 曖昧一致＋第1巻＋短タイトル | 30点 | 除外される ✓ |
| Contains Match | 50点 | 残る ✓ |
| Contains Match＋第1巻 | 70点 | 残る ✓ |

### 5.3 動作ロジック
```
if (topResult.score >= 40) {
  results = results.filter(r => r.score >= 40);
}
```

**ソースコード参照**: [`src/app/api/search/route.ts#L424-L431`](file:///c:/Users/tyuda/.gemini/antigravity/scratch/the-five-app/src/app/api/search/route.ts#L424-L431)

---

## 6. マッチング戦略（CF-09対応）

### 6.1 二重マッチング
正規化の不可逆性を回避するため、以下の2段階でマッチング：
1. **正規化後マッチング**: 高速・広範囲
2. **元文字列マッチング**: 精度確保

### 6.2 表示時の挙動
- 検索結果の表示には**元のタイトル表記**を使用
- 正規化はマッチング判定のみに使用

---

## 7. エッジケース処理

| ケース | 挙動 |
|---|---|
| 空文字列クエリ | エラー返却（400 Bad Request） |
| 1文字クエリ | 許可（ただし結果は限定的） |
| 100文字超クエリ | 100文字で切り捨て |
| 絵文字 | 除去して検索 |
| 全角英数字 | 半角に変換 |
| 改行・タブ | 空白に変換 |
| SQLインジェクション | 楽天APIがエスケープ |
| 0巻 | 第1巻ボーナス非適用 |
| 0.5巻 | 第1巻ボーナス非適用 |
| 複数巻指定（1-3） | 非対応（最初の数字のみ抽出） |

---

## 8. 巻数解釈ルール（MI-04対応）

### 8.1 抽出パターン（優先順）
1. `(\d+)巻` → 「72巻」
2. `第(\d+)巻` → 「第72巻」
3. `[（(](\d+)[)）]` → 「(72)」「（72）」
4. `Vol\.?\s*(\d+)` → 「Vol.72」
5. 末尾の数字 `\s(\d+)$` → 「ONE PIECE 72」

### 8.2 数字解釈の制限
- 0〜999の範囲のみ巻数として解釈
- 1000以上は巻数として**解釈しない**
- 「ULTRAMAN 1」の「1」は末尾数字のため巻数として解釈

---

## 9. テストケース（必須パス）

| テストID | クエリ | 期待結果 |
|---|---|---|
| T01 | `ハヤテのごとく` | スコア80以上、ONE PIECEが含まれない |
| T02 | `ONE PIECE` | スコア60以上、第1巻が上位 |
| T03 | `ONE PIECE ファンブック` | ファンブックが結果に含まれる |
| T04 | `茶の涙` | 「茶の涙」シリーズがヒット |
| T05 | `""` | 400エラー |
| T06 | `a` × 150文字 | 100文字で切り捨て後に検索 |

---

*Blue Team Response Completed: 2026-02-04*
